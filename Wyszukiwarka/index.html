<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-sRIl4kxILFvY47J16cr9ZwB07vP4J8+LH7qKQnuqkuIAvNWLzeN8tE5YBujZqJLB" crossorigin="anonymous">
<script type="module">
const loadingDiv = document.querySelector("#loading");
import { PGlite } from 'https://cdn.jsdelivr.net/npm/@electric-sql/pglite/dist/index.js';
import { vector } from 'https://cdn.jsdelivr.net/npm/@electric-sql/pglite/dist/vector/index.js';
const db = new PGlite({
  extensions: { vector }
});
await db.exec(`CREATE TABLE IF NOT EXISTS transcriptions (source text, date date, transcription text);`);
const blob = await fetch('https://codziennatranskrypcjatvpis.github.io/Wyszukiwarka/pliki').blob();
await db.query(
          `COPY transcriptions FROM '/dev/blob' WITH DELIMITER ';;;;;' CSV;`,
          [],
          {
            blob,
          }
        );
await db.exec(`alter table transcriptions add search tsvector generated always as (to_tsvector('english', transcription)) STORED;`);
loadingDiv.classList.add("d-none");

async function search (phrase) {
        return await db.query(`
        select source,
        string_to_array(ts_headline(transcription, websearch_to_tsquery('${phrase}'), 'MaxFragments=100, FragmentDelimiter=;DELIMITER;'), ';DELIMITER;') as occurences
        from transcriptions where
        search @@ websearch_to_tsquery('${phrase}')
        order by date desc;`);
}

const resultsDiv = document.querySelector("#results");
document.querySelector("#button-addon2").addEventListener("click", function () {
        loadingDiv.classList.remove("d-none");
        resultsDiv.innerHTML = '';
	search(document.querySelector("#input").value).then(result => {
        const virtualDiv = document.createElement('div');
        result.rows.forEach(row => {
                const div = document.createElement('div');
                div.className = 'col-lg-12';
                const h = document.createElement('h3');
                const anchor = document.createElement('a');
                anchor.href = 'https://codziennatranskrypcjatvpis.github.io/transcriptions_txt/' + row.source;
                anchor.innerText = row.source;
                h.appendChild(anchor);
		h.appendChild(document.createTextNode(" (" + row.occurences.length + ")"));
                div.appendChild(h);
                row.occurences.forEach(o => {
                        const blockquote = document.createElement('blockquote');
                        blockquote.className = 'blockquote';
                        blockquote.innerHTML = o;
                        div.appendChild(blockquote);
                });
                virtualDiv.appendChild(div);
        });
        loadingDiv.classList.add("d-none");
        resultsDiv.innerHTML = virtualDiv.innerHTML;
	});
});

</script>
</head>
<body>
<div class="container">
<div class="input-group mb-3">
  <input type="text" class="form-control" placeholder="Fraza wyszukiwania" aria-label="Fraza wyszukiwania" aria-describedby="button-addon2" id="input">
  <button class="btn btn-outline-secondary" type="button" id="button-addon2">Szukaj</button>
</div>
<div id="loading">≈Åadowanie</div>
<div class="row" id="results">
</div>
</div>
</div>
</body>
</html>
